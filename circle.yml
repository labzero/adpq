machine:
  pre:
    - curl -sSL https://s3.amazonaws.com/circle-downloads/install-circleci-docker.sh | bash -s -- 1.10.0
  services:
    - docker
dependencies:
  pre:
    - script/ci/prepare.sh
  post:
    - docker build --rm=false -t $AWS_ACCOUNT_ID.dkr.ecr.us-west-1.amazonaws.com/adpq:$CIRCLE_SHA1 .
  cache_directories:
    - ~/dependencies
    - ~/.mix
    - _build
    - deps
    - node_modules
database:
  override:
    - createuser -d adpq
test:
  override:
    - mkdir -p $CIRCLE_TEST_REPORTS/test
    - script/ci/tests.sh
deployment:
  production:
    branch: develop
    commands:
      - script/ci/deploy-prod.sh